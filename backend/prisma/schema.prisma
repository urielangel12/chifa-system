generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
   directUrl = env("DIRECT_URL")
}

model Mesa {
  id        Int      @id @default(autoincrement())
  numero    Int      @unique // ✅ evita duplicadas
  estado    String
  createdAt DateTime @default(now())

  pedidos Pedido[]
}

model Plato {
  id           Int             @id @default(autoincrement())
  nombre       String
  precio       Float
  activo       Boolean         @default(true)
  createdAt    DateTime        @default(now())
  categoria    String
  subcategoria String?
  detalles     PedidoDetalle[]
}

model Pedido {
  id        Int      @id @default(autoincrement())
  mesaId    Int
  usuarioId Int?
  jornadaId Int?
  total     Float    @default(0)
  estado    String
  createdAt DateTime @default(now())

  mesa     Mesa            @relation(fields: [mesaId], references: [id])
  usuario  Usuario?        @relation(fields: [usuarioId], references: [id])
  jornada  Jornada?        @relation(fields: [jornadaId], references: [id])
  detalles PedidoDetalle[]
  pagos    Pago[]

  @@index([estado]) // ✅ filtrar ABIERTO/PAGADO rápido
  @@index([mesaId]) // ✅ /pedidos/mesa/:id
  @@index([jornadaId]) // ✅ reportes por jornada
  @@index([estado, mesaId]) // ✅ tu endpoint /mesas (ABIERTO por mesa)
  @@index([estado, jornadaId]) // ✅ reportes (PAGADO por jornada)
  @@index([createdAt]) // ✅ ordenamientos / cortes por fecha
}

model Pago {
  id          Int       @id @default(autoincrement())
  pedido      Pedido    @relation(fields: [pedidoId], references: [id])
  pedidoId    Int
  monto       Float
  metodoPago  String?
  fechaCierre DateTime?
  createdAt   DateTime  @default(now())

  @@index([pedidoId])
  @@index([metodoPago])
  @@index([createdAt])
}

model PedidoDetalle {
  id             Int   @id @default(autoincrement())
  pedidoId       Int
  platoId        Int
  cantidad       Int
  cantidadPagada Int   @default(0)
  precio         Float
  subtotal       Float

  pedido Pedido @relation(fields: [pedidoId], references: [id])
  plato  Plato  @relation(fields: [platoId], references: [id])

  @@index([pedidoId, platoId])
}

model Caja {
  id           Int              @id @default(autoincrement())
  fecha        DateTime         @default(now())
  montoInicial Float
  montoFinal   Float?
  estado       String // ABIERTA | CERRADA
  movimientos  MovimientoCaja[]
}

model MovimientoCaja {
  id        Int      @id @default(autoincrement())
  cajaId    Int
  tipo      String // INGRESO | EGRESO
  concepto  String
  monto     Float
  createdAt DateTime @default(now())

  caja Caja @relation(fields: [cajaId], references: [id])

  @@index([cajaId])
}

model Usuario {
  id        Int      @id @default(autoincrement())
  nombre    String
  email     String   @unique
  password  String
  rol       String // ADMIN | MOZO | CAJA
  createdAt DateTime @default(now())

  pedidos Pedido[] //Esta linea es clave
}

model Jornada {
  id            Int       @id @default(autoincrement())
  fecha         DateTime
  estado        Boolean   @default(true)
  totalVentas   Float     @default(0)
  cierre        DateTime?
  createdAt     DateTime  @default(now())
  observaciones String?

  pedidos Pedido[]

  @@index([estado])
  @@index([cierre])
  @@index([fecha])
}
